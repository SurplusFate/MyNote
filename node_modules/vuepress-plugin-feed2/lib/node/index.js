"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@vuepress/utils"),e=require("vuepress-shared"),i=require("@vuepress/shared"),a=require("path"),r=require("xml-js");const n=new e.Logger("vuepress-plugin-feed2"),s=(t,e)=>t&&t instanceof Date?e&&e instanceof Date?e.getTime()-t.getTime():-1:1,o=(t,e=[])=>t.replace(/ class=".*?"/gu,"").replace(/ v-pre/gu,"").replace(/<a href="#.*?">.*?<\/a>/gu,"").replace(/(<!--.*?--!?>)|(<!--[\S\s]+?--!?>)|(<!--[\S\s]*?$)/gu,"").replace(/<ExternalLinkIcon ?\/>/gu,"").replace(/<RouterLink to="(.*?)">(.*?)<\/RouterLink>/gu,'<a href="$1">$2</a>').replace(/<(?:a|div|span)[^>]*?\/>/gu,"").replace(new RegExp(`<(${e.join("|")})[^>]*?(?:>*?<\\/\\1>|\\/>)`,"gu"),"<i>Content not supported</i>").replace(/<math[\s\S]*?\/math>/gu,"<i>Content not supported</i>"),p=(t,e="",a="")=>`${t}${e}${i.removeLeadingSlash(a)}`,u=(t="")=>`image/${"jpg"===t?"jpeg":"svg"===t?"svg+xml":"jpeg"===t||"png"===t||"bmp"===t||"gif"===t||"webp"===t?t:""}`,l=t=>{t.atom=t.output?.atom?.enable??!0,t.json=t.output?.json?.enable??!0,t.rss=t.output?.rss?.enable??!0,t.atomOutputFilename=t.output?.atom?.path??"atom.xml",t.jsonOutputFilename=t.output?.json?.path??"feed.json",t.jsonOutputFilename=t.output?.rss?.path??"rss.xml",((t,e,i="",a="")=>{e in t&&(n.error(`"${e}" is removed${a?`, please use ${a} instead.`:" and no longer supported"}${i?`\n${i}`:""}`),a||delete t[e])})(t,"output")},c=(t,i,a="")=>{const{base:r}=t.options,{title:n,description:s,lang:o,locales:u}=t.siteData,{hostname:l,icon:c,image:h}=i,d=i.channel?.author?.name,g={title:u[a]?.title||n||u["/"]?.title||"",link:p(l,r,a),description:u[a]?.description||s||u["/"]?.description||"",language:u[a]?.lang||o,copyright:d?`Copyright by ${d}`:"",pubDate:new Date,lastUpdated:new Date,...c?{icon:c}:{},...h?{image:h}:{},...d?{author:{name:d}}:{}};return e.deepAssign(g,i.channel||{})},h=(t,e="/")=>({atomOutputFilename:`${i.removeLeadingSlash(e)}${t.atomOutputFilename||"atom.xml"}`,jsonOutputFilename:`${i.removeLeadingSlash(e)}${t.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${i.removeLeadingSlash(e)}${t.rssOutputFilename||"rss.xml"}`}),d=({options:{base:t}},e)=>{const{hostname:i}=e,{atomOutputFilename:a,jsonOutputFilename:r,rssOutputFilename:n}=h(e);return{atom:p(i,t,a),json:p(i,t,r),rss:p(i,t,n)}},g=t=>{const{name:i="Unknown",email:a,url:r}=t;return{name:i,...a?{email:a}:{},...r?{uri:e.encodeXML(r)}:{}}},m=t=>{const i=t.guid||e.encodeXML(t.link);return{...e.isUrl(i)?{}:{_attributes:{isPermaLink:!1}},_text:i}};class f{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=t=>{this.items.push(t)},this.addCategory=t=>{this.categories.add(t)},this.addContributor=t=>{const e=t.email||t.name;e&&!this._contributorKeys.has(e)&&(this._contributorKeys.add(e),this.contributors.push(t))},this.atom=()=>(t=>{const{channel:i,links:a}=t.options,n={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...i.language?{"xml:lang":i.language}:{}},id:i.link,title:i.title,...i.description?{subtitle:i.description}:{},...i.author?{author:g(i.author)}:{},updated:i.lastUpdated?i.lastUpdated.toISOString():(new Date).toISOString(),generator:"vuepress-plugin-feed2",link:[{_attributes:{rel:"self",href:e.encodeXML(a.atom)}}]}};return i.link&&n.feed.link.push({_attributes:{rel:"alternate",href:e.encodeXML(i.link)}}),i.hub&&n.feed.link.push({_attributes:{rel:"hub",href:e.encodeXML(i.hub)}}),i.image&&(n.feed.logo=i.image),i.icon&&(n.feed.icon=i.icon),i.copyright&&(n.feed.rights=i.copyright),n.feed.category=Array.from(t.categories).map((t=>({_attributes:{term:t}}))),n.feed.contributor=Array.from(t.contributors).filter((t=>t.name)).map((t=>g(t))),n.feed.entry=t.items.map((t=>{const i={title:{_attributes:{type:"html"},_text:e.encodeXML(t.title)},id:e.encodeXML(t.guid||t.link),link:{_attributes:{href:e.encodeXML(t.link)}},updated:t.lastUpdated.toISOString()};return t.description&&(i.summary=t.description.startsWith("html:")?{_attributes:{type:"html"},_cdata:e.encodeCDATA(t.description.substring(5))}:{_attributes:{type:"html"},_text:t.description}),t.content&&(i.content={_attributes:{type:"html"},_cdata:e.encodeCDATA(t.content)}),t.author&&(i.author=t.author.filter((t=>t.name)).map((t=>g(t)))),t.category&&(i.category=t.category.map((t=>(t=>{const{name:e,scheme:i=""}=t;return{_attributes:{term:e,scheme:i}}})(t)))),t.contributor&&(i.contributor=t.contributor.map((t=>g(t)))),t.pubDate&&(i.published=t.pubDate.toISOString()),t.copyright&&(i.rights=t.copyright),i})),r.js2xml(n,{compact:!0,ignoreComment:!0,spaces:2})})(this),this.rss=()=>(t=>{const{links:i,channel:a}=t.options;let n=!1;const s={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:i.rss,rel:"self",type:"application/rss+xml"}},title:{_text:a.title},link:{_text:e.encodeXML(a.link)},description:{_text:a.description},language:{_text:e.encodeXML(a.language)},pubDate:{_text:a.pubDate?a.pubDate.toUTCString():(new Date).toUTCString()},lastBuildDate:{_text:a.lastUpdated?a.lastUpdated.toUTCString():(new Date).toUTCString()},generator:{_text:"vuepress-plugin-feed2"},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return a.copyright&&(s.rss.channel.copyright={_text:a.copyright}),a.ttl&&(s.rss.channel.ttl={_text:a.ttl.toString()}),a.image&&(s.rss.channel.image={title:{_text:a.title},url:{_text:a.image},link:{_text:e.encodeXML(a.link)}}),s.rss.channel.category=Array.from(t.categories).map((t=>({_text:t}))),s.rss.channel.item=t.items.map((t=>{const a={title:{_text:e.encodeXML(t.title)},link:{_text:e.encodeXML(t.link)},guid:m(t),source:{_attributes:{url:i.rss},_text:t.title}};if(t.description&&(a.description={_text:t.description.startsWith("html:")?e.stripTags(t.description.substring(5)):t.description}),t.author){const e=t.author.find((t=>t.email&&t.name));e&&(a.author={_text:`${e.email} (${e.name})`})}var r;return t.category&&(a.category=t.category.filter((t=>t.name)).map((t=>(t=>{const{name:e,domain:i}=t;return{_text:e,...i?{_attributes:{domain:i}}:{}}})(t)))),t.comments&&(a.comments={_text:e.encodeXML(t.link)}),t.pubDate&&(a.pubDate={_text:t.pubDate.toUTCString()}),t.content&&(n=!0,a["content:encoded"]={_cdata:e.encodeCDATA(t.content)}),t.enclosure&&(a.enclosure={_attributes:{url:(r=t.enclosure).url,...r.length?{length:r.length}:{},...r.type?{type:r.type}:{}}}),a})),n&&(s.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",s.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),r.js2xml(s,{compact:!0,ignoreComment:!0,spaces:2})})(this),this.json=()=>(t=>{const{channel:i,links:a}=t.options,r={version:"https://jsonfeed.org/version/1.1",title:i.title,home_page_url:i.link,feed_url:a.json};return i.description&&(r.description=i.description),i.image&&(r.icon=i.image),i.icon&&(r.favicon=i.icon),i.author?.name&&(r.author={name:i.author.name,...i.author.url?{url:i.author.url}:{},...i.author.avatar?{avatar:i.author.avatar}:{}}),r.items=t.items.map((t=>{const i={title:t.title,url:t.link,id:t.guid||t.link,...t.description?{summary:t.description.startsWith("html:")?e.stripTags(t.description.substring(5)):t.description}:{},content_html:t.content};return t.image&&(i.image=t.image),t.pubDate&&(i.date_published=t.pubDate.toISOString()),t.lastUpdated&&(i.date_modified=t.lastUpdated.toISOString()),Array.isArray(t.author)&&(i.authors=t.author.filter((t=>t.name)).map((t=>(t=>({name:t.name,...t.url?{url:t.url}:{},...t.avatar?{avatar:t.avatar}:{}}))(t)))),t.category&&(i.tags=t.category.filter((t=>t.name)).map((t=>t.name))),i})),JSON.stringify(r,null,2)})(this)}}class b{constructor(t,e,i,a){this.app=t,this.options=e,this.page=i,this.feed=a,this.base=this.app.options.base,this.frontmatter=i.frontmatter,this.getter=e.getter||{},this.pageFeedOptions=this.frontmatter.feed||{}}get title(){return"function"==typeof this.getter.title?this.getter.title(this.page):this.pageFeedOptions.title||this.page.title}get link(){return"function"==typeof this.getter.link?this.getter.link(this.page):p(this.options.hostname,this.base,this.page.path)}get description(){return"function"==typeof this.getter.description?this.getter.description(this.page):this.pageFeedOptions.description?this.pageFeedOptions.description:this.frontmatter.description?this.frontmatter.description:this.page.excerpt?`html:${o(this.app.markdown.render(this.page.excerpt),this.options.customElements)}`:null}get author(){return"function"==typeof this.getter.author?this.getter.author(this.page):Array.isArray(this.pageFeedOptions.author)?this.pageFeedOptions.author:"object"==typeof this.pageFeedOptions.author?[this.pageFeedOptions.author]:!1===this.frontmatter.author?[]:this.frontmatter.author?e.getAuthor(this.frontmatter.author):this.options.channel?.author?e.getAuthor(this.options.channel?.author):[]}get category(){if("function"==typeof this.getter.category)return this.getter.category(this.page);if(Array.isArray(this.pageFeedOptions.category))return this.pageFeedOptions.category;if("object"==typeof this.pageFeedOptions.category)return[this.pageFeedOptions.category];const{categories:t,category:i=t}=this.frontmatter;return e.getCategory(i).map((t=>({name:t})))}get enclosure(){return"function"==typeof this.getter.enclosure?this.getter.enclosure(this.page):this.image?{url:this.image,type:u(this.image.split(".").pop())}:null}get guid(){return this.pageFeedOptions.guid||this.link}get pubDate(){if("function"==typeof this.getter.publishDate)return this.getter.publishDate(this.page);const{time:t,date:e=t}=this.page.frontmatter,{createdTime:i}=this.page.data.git||{};return e&&e instanceof Date?e:i?new Date(i):null}get lastUpdated(){if("function"==typeof this.getter.lastUpdateDate)return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get content(){return"function"==typeof this.getter.content?this.getter.content(this.page):this.pageFeedOptions.content?this.pageFeedOptions.content:o(this.page.contentRendered,this.options.customElements)}get image(){if("function"==typeof this.getter.image)return this.getter.image(this.page);const{banner:t,cover:i}=this.frontmatter;if(t){if(e.isAbsoluteUrl(t))return p(this.options.hostname,this.app.options.base,t);if(e.isUrl(t))return t}if(i){if(e.isAbsoluteUrl(i))return p(this.options.hostname,this.app.options.base,i);if(e.isUrl(i))return i}const a=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(a){if(e.isAbsoluteUrl(a[1]))return p(this.options.hostname,this.app.options.base,a[1]);if(e.isUrl(a[1]))return a[1]}return null}get contributor(){return"function"==typeof this.getter.contributor?this.getter.contributor(this.page):Array.isArray(this.pageFeedOptions.contributor)?this.pageFeedOptions.contributor:"object"==typeof this.pageFeedOptions.contributor?[this.pageFeedOptions.contributor]:this.author}get copyright(){if("function"==typeof this.getter.copyright)return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t?.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:e,content:i,contributor:a,copyright:r,description:n,enclosure:s,guid:o,image:p,lastUpdated:u,link:l,pubDate:c,title:h}=this;return h||n?(e&&e.forEach((t=>this.feed.addCategory(t.name))),a&&a.forEach((t=>this.feed.addContributor(t))),{title:h,link:l,guid:o,lastUpdated:u,content:i,author:t,contributor:a,...n?{description:n}:{},...e?{category:e}:{},...s?{enclosure:s}:{},...c?{pubDate:c}:{},...p?{image:p}:{},...r?{copyright:r}:{}}):null}}class y{constructor(t,e){this.app=t,this.options=e,this.feedMap=Object.fromEntries(Object.entries(e).map((([e,i])=>[e,new f({channel:c(t,i,e),links:d(t,i)})])))}addPages(e){const i=this.feedMap[e],a=this.options[e],{count:r=100,filter:o=(({frontmatter:t,filePathRelative:e})=>!(t.home||!e||!1===t.article||!1===t.feed)),sorter:p=((t,e)=>s(t.data.git?.createdTime?new Date(t.data.git?.createdTime):t.frontmatter.date,e.data.git?.createdTime?new Date(e.data.git?.createdTime):e.frontmatter.date))}=a,u=this.app.pages.filter((t=>t.pathLocale===e)).filter(o).sort(p).slice(0,r);let l=0;for(const t of u){const e=new b(this.app,a,t,i).getFeedItem();e&&(i.addItem(e),l+=1)}n.succeed(`added ${t.chalk.cyan(`${l} page(s)`)} as feed item(s) in route ${t.chalk.cyan(e)}`)}async generateFeed(){const{dest:e}=this.app.dir;await Promise.all(Object.entries(this.options).map((async([i,r])=>{if(r.atom||r.json||r.rss){const s=this.feedMap[i],{atomOutputFilename:o,jsonOutputFilename:p,rssOutputFilename:u}=h(r,i);this.addPages(i),r.atom&&(await t.fs.ensureDir(a.dirname(e(o))),await t.fs.outputFile(e(o),s.atom()),n.succeed(`Atom feed file generated and saved to ${t.chalk.cyan(o)}`)),r.json&&(await t.fs.ensureDir(a.dirname(e(p))),await t.fs.outputFile(e(p),s.json()),n.succeed(`JSON feed file generated and saved to ${t.chalk.cyan(p)}`)),r.rss&&(await t.fs.ensureDir(a.dirname(e(u))),await t.fs.outputFile(e(u),s.rss()),n.succeed(`RSS feed file generated and saved to ${t.chalk.cyan(u)}`))}})))}}const _=(e,a=!1)=>r=>{a&&l(e),r.env.isDebug&&n.info(`Options: ${e.toString()}`);const o={name:"vuepress-plugin-feed2"};if(!(t=>!!t.hostname&&(t.hostname=i.removeEndingSlash(t.hostname),!0))(e))return n.error(`Option ${t.chalk.magenta("hostname")} is required!`),o;if(!(t=>t.locales&&Object.entries(t.locales).some((([,{atom:t,json:e,rss:i}])=>t||e||i))||Boolean(t.atom||t.json||t.rss))(e))return n.info("No requested output, the plugin won’t start!"),o;const u=(({siteData:t},e)=>Object.fromEntries(Object.keys({"/":{},...t.locales}).map((t=>[t,{filter:({frontmatter:t,filePathRelative:e})=>!(t.home||!e||!1===t.article||!1===t.feed),sorter:(t,e)=>s(t.data.git?.createdTime?new Date(t.data.git?.createdTime):t.frontmatter.date,e.data.git?.createdTime?new Date(e.data.git?.createdTime):e.frontmatter.date),...e,...e.locales?.[t],hostname:e.hostname}]))))(r,e);return{...o,onPrepared:t=>((t,e)=>{const{base:i}=t.options,{siteData:a}=t,r=Object.keys(e);if(1===r.length){const{atomOutputFilename:t,jsonOutputFilename:r,rssOutputFilename:n}=h(e["/"]),{atom:s,json:o,rss:u,hostname:l}=e["/"],c=(t,e,r)=>["link",{rel:"alternate",type:r,href:p(l,i,e),title:`${a.title||a.locales["/"]?.title||""} ${t} Feed`}];a.head||(a.head=[]),s&&a.head.push(c("Atom",t,"application/atom+xml")),o&&a.head.push(c("JSON",r,"application/json")),u&&a.head.push(c("RSS",n,"application/rss+xml"))}else t.pages.forEach((t=>{const{pathLocale:n}=t,s=e[n];if(r.includes(n)){const{atomOutputFilename:e,jsonOutputFilename:r,rssOutputFilename:o}=h(s,n),u=(t,e,r)=>["link",{rel:"alternate",type:r,href:p(s.hostname,i,e),title:`${a.locales[n]?.title||a.title||a.locales["/"]?.title||""} ${t} Feed`}];t.frontmatter.head||(t.frontmatter.head=[]),s.atom&&t.frontmatter.head.push(u("Atom",e,"application/atom+xml")),s.json&&t.frontmatter.head.push(u("JSON",r,"application/json")),s.rss&&t.frontmatter.head.push(u("RSS",o,"application/rss+xml"))}}))})(t,u),onGenerated:async t=>{await new y(t,u).generateFeed()}}};exports.default=_,exports.feedPlugin=_;
//# sourceMappingURL=index.js.map
